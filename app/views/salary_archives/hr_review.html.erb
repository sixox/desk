<div class="col-lg-10 mx-auto mt-5">

<h4 class="mb-3">بررسی HR — <%= @shamsi_month.name %></h4>

<div class="d-flex flex-wrap gap-2 mb-3">
  <%= link_to "Manager Review",
        manager_review_salary_archives_path(month_id: @shamsi_month.id),
        class: "btn btn-outline-primary btn-sm" %>

  <% if current_user.id == 17 || current_user.id == 1 %>
    <%= button_to "HR Confirm (برای کل ماه)",
          hr_confirm_all_salary_archives_path(month_id: @shamsi_month.id),
          method: :patch,
          class: "btn btn-success btn-sm",
          data: { turbo_confirm: "برای این ماه، HR Confirm همه‌ی کاربران ثبت شود؟" } %>
  <% end %>
</div>

<div class="accordion" id="hrReviewAcc">
  <% @users.each do |user| %>
    <% archive = @archives[user.id] %>
    <% next unless archive %>

    <% pay_type_label = @pay_type_by_user_id[user.id] || "نامشخص" %>

    <%# ===== Manager confirm badge ===== %>
    <% mgr_confirmed   = archive.manager_confirmed_at.present? %>
    <% mgr_badge_text  = mgr_confirmed ? "Manager Confirmed" : "Manager Pending" %>
    <% mgr_badge_class = mgr_confirmed ? "text-bg-primary" : "text-bg-secondary" %>

    <%# ===== HR confirm badge ===== %>
    <% hr_badge_text  = archive.hr_confirmed ? "HR Confirmed" : "HR Pending" %>
    <% hr_badge_class = archive.hr_confirmed ? "text-bg-success" : "text-bg-secondary" %>

    <div class="accordion-item">
      <h2 class="accordion-header" id="hdr_<%= user.id %>">
        <button class="accordion-button collapsed py-2" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#col_<%= user.id %>"
                aria-expanded="false"
                aria-controls="col_<%= user.id %>">

          <div class="d-flex w-100 align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-2">
              <span class="fw-semibold">
                <%= user.name.presence || "کاربر ##{user.id}" %>
              </span>
              <span class="badge text-bg-light border">
                <%= pay_type_label %>
              </span>
            </div>

            <div class="d-flex align-items-center gap-2">
              <span class="badge <%= mgr_badge_class %>">
                <%= mgr_badge_text %>
              </span>
              <span class="badge <%= hr_badge_class %>">
                <%= hr_badge_text %>
              </span>
            </div>
          </div>

        </button>
      </h2>

      <div id="col_<%= user.id %>" class="accordion-collapse collapse"
           aria-labelledby="hdr_<%= user.id %>"
           data-bs-parent="#hrReviewAcc">

        <div class="accordion-body p-2">

          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-2">
              <thead class="table-light">
                <tr>
                  <th>تاریخ</th>
                  <th>ورود</th>
                  <th>خروج</th>
                  <th class="text-end">کسری (ساعت)</th>
                  <th class="text-end">اضافه‌کاری (ساعت)</th>
                  <th>مرخصی</th>
                  <th>دورکاری</th>
                </tr>
              </thead>

              <tbody>
                <% archive.days.sort_by(&:work_date).each do |day| %>
                  <% d = day.work_date %>

                  <% is_off = @off_dates.include?(d) %>
                  <% weekday = @weekday_fa[d.wday] %>

                  <% vinfo = (@vacation_info_by_user_date[user.id] || {})[d] %>
                  <% has_vac = vinfo.present? %>
                  <% vac_daily = has_vac && vinfo[:kind] == :daily %>
                  <% vac_confirmed = has_vac && vinfo[:confirmed] == true %>

                  <% remote_day = (@remote_days_by_user_date[user.id] || {})[d] %>
                  <% remote_confirmed = remote_day.present? && (remote_day.confirmed != false) %>

                  <% row_classes = [] %>
                  <% row_classes << "table-danger" if is_off %>
                  <% row_classes << "table-warning" if vac_daily && vac_confirmed %>
                  <% row_classes << "table-info" if remote_day.present? && remote_confirmed %>

                  <tr class="<%= row_classes.join(" ") %>">
                    <td>
                      <div class="fw-semibold"><%= d.strftime("%Y/%m/%d") %></div>
                      <div class="small text-muted"><%= weekday %></div>
                    </td>

                    <td>
                      <span class="badge text-bg-light border">
                        <%= day.first_in_at.presence || "—" %>
                      </span>
                    </td>

                    <td>
                      <span class="badge text-bg-light border">
                        <%= day.last_out_at.presence || "—" %>
                      </span>
                    </td>

                    <td class="text-end">
                      <span class="badge text-bg-light border">
                        <%= @fmt_hours.call(day.deficit_minutes) %>
                      </span>
                    </td>

                    <td class="text-end">
                      <span class="badge text-bg-light border">
                        <%= @fmt_hours.call(day.overtime_minutes) %>
                      </span>
                    </td>

                    <td>
                      <% if has_vac %>
                        <span class="badge text-bg-warning">مرخصی</span>
                        <span class="badge <%= vac_confirmed ? "text-bg-success" : "text-bg-secondary" %>">
                          <%= vac_confirmed ? "تأیید" : "عدم تأیید" %>
                        </span>
                      <% else %>
                        <span class="text-muted small">—</span>
                      <% end %>
                    </td>

                    <td>
                      <% if remote_day.present? %>
                        <span class="badge <%= remote_confirmed ? "text-bg-info" : "text-bg-secondary" %>">
                          دورکاری
                        </span>
                      <% else %>
                        <span class="text-muted small">—</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2 small">
            <span class="badge text-bg-light border">
              جمع کسری: <%= @fmt_hours.call(archive.deficit_minutes) %> ساعت
            </span>
            <span class="badge text-bg-light border">
              جمع اضافه‌کاری: <%= @fmt_hours.call(archive.overtime_minutes) %> ساعت
            </span>
            <span class="badge text-bg-light border">
              کسری دستی: <%= @fmt_hours.call(archive.manual_deficit_minutes) %> ساعت
            </span>
            <span class="badge text-bg-light border">
              اضافه‌کاری دستی: <%= @fmt_hours.call(archive.manual_overtime_minutes) %> ساعت
            </span>
          </div>

        </div>
      </div>
    </div>
  <% end %>
</div>
</div>
