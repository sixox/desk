<%# app/views/salary_archives/_payslip_card.html.erb %>
<%
  money = ->(n) { number_with_delimiter(n.to_i) }
  hours = ->(mins) { ((mins.to_i) / 60.0).round(2) }

  month_days = (shamsi_month.end_at.to_date - shamsi_month.start_at.to_date).to_i + 1
  adjust_30_to_month = ->(monthly_amount) { ((monthly_amount.to_f / 30.0) * month_days).round }

  base_salary   = archive.seniority_base.to_i
  paye_sanavat  = archive.monthly_seniority_base.to_i

  marriage      = archive.marriage_allowance.to_i
  child         = archive.child_allowance.to_i
  housing       = archive.housing_allowance.to_i
  food          = archive.food_allowance.to_i

  legal_salary  = base_salary + marriage + housing + food + paye_sanavat
  insurance     = archive.insurance.to_i
  payment_1     = legal_salary - insurance

  total_salary_adj = adjust_30_to_month.call(archive.total_salary.to_i)

  total_work_h = hours.call(archive.total_work_minutes)

  overtime_mins = archive.manual_overtime_minutes.to_i != 0 ? archive.manual_overtime_minutes.to_i : archive.overtime_minutes.to_i
  deficit_mins  = archive.manual_deficit_minutes.to_i  != 0 ? archive.manual_deficit_minutes.to_i  : archive.deficit_minutes.to_i

  overtime_h = hours.call(overtime_mins)
  deficit_h  = hours.call(deficit_mins)

  hourly_rate = archive.hourly_rate.present? ? archive.hourly_rate.to_f : 0.0

  loan   = archive.loan_installment.to_i
  fund3  = archive.fund_three_percent.to_i
  fund6  = archive.fund_six_percent.to_i

  overtime_pay      = (overtime_h * hourly_rate * 1.4)
  deficit_deduction = (deficit_h  * hourly_rate)

  payment_2 = (total_salary_adj - fund6 - fund3 - loan - deficit_deduction + overtime_pay).round
%>

<style>
  /* minimal, classy, inside-card only */
  .ps-card { border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.06); border: 1px solid rgba(0,0,0,.06); overflow: hidden; }
  .ps-header { padding: 14px 16px; background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,0)); border-bottom: 1px solid rgba(0,0,0,.06); }
  .ps-title { font-weight: 800; letter-spacing: -.2px; }
  .ps-sub { font-size: .82rem; color: #6c757d; }
  .ps-kpi { border: 1px solid rgba(0,0,0,.06); border-radius: 14px; padding: 10px 12px; background: #fff; }
  .ps-kpi .lbl { font-size: .78rem; color: #6c757d; }
  .ps-kpi .val { font-size: 1.12rem; font-weight: 800; letter-spacing: -.2px; }
  .ps-grid { padding: 12px 16px 16px; }
  .ps-section { border: 1px solid rgba(0,0,0,.06); border-radius: 14px; padding: 12px 12px; background: #fff; height: 100%; }
  .ps-section .hd { font-weight: 800; font-size: .92rem; margin-bottom: 10px; }
  .ps-row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 8px 0; border-bottom: 1px dashed rgba(0,0,0,.10); }
  .ps-row:last-child { border-bottom: 0; }
  .ps-row .k { font-size: .83rem; color: #6c757d; }
  .ps-row .v { font-size: .88rem; font-weight: 700; }
  .ps-pill { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(0,0,0,.08); background:#fff; font-size: .78rem; color:#343a40; }
  .ps-footer { padding: 12px 16px; background: #fff; border-top: 1px solid rgba(0,0,0,.06); }
  .ps-mini { font-size: .8rem; color:#6c757d; }
</style>

<div class="ps-card" id="payslip_card_<%= archive.id %>">
  <div class="ps-header">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
      <div>
        <div class="ps-title">فیش حقوقی — <%= user&.name.presence || "کاربر ##{archive.user_id}" %></div>
        <div class="ps-sub">
          ماه: <%= shamsi_month.name %> • <%= month_days %> روز • آرشیو: #<%= archive.id %>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <span class="ps-pill">پرداختی اول: <strong><%= money.call(payment_1) %></strong></span>
        <span class="ps-pill">پرداختی دوم: <strong><%= money.call(payment_2) %></strong></span>
      </div>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-12 col-md-6">
        <div class="ps-kpi">
          <div class="lbl">پرداختی اول (قانونی)</div>
          <div class="val"><%= money.call(payment_1) %></div>
          <div class="ps-mini">حقوق قانونی − بیمه (۷٪)</div>
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div class="ps-kpi">
          <div class="lbl">پرداختی دوم (عملکرد + تعدیلات)</div>
          <div class="val"><%= money.call(payment_2) %></div>
          <div class="ps-mini">حقوق مصوب ± اضافه‌کاری/کسری − ذخایر − وام</div>
        </div>
      </div>
    </div>
  </div>

  <div class="ps-grid">
    <div class="row g-3">

      <%# --- پایه‌ها و مزایا (مرتبط‌ها کنار هم) --- %>
      <div class="col-12 col-lg-4">
        <div class="ps-section">
          <div class="hd">حقوق پایه و مزایا</div>

          <div class="ps-row"><span class="k">حقوق پایه</span><span class="v"><%= money.call(base_salary) %></span></div>
          <div class="ps-row"><span class="k">پایه سنوات</span><span class="v"><%= money.call(paye_sanavat) %></span></div>

          <div class="ps-row"><span class="k">حق مسکن</span><span class="v"><%= money.call(housing) %></span></div>
          <div class="ps-row"><span class="k">خواربار</span><span class="v"><%= money.call(food) %></span></div>

          <div class="ps-row"><span class="k">حق تأهل</span><span class="v"><%= money.call(marriage) %></span></div>
          <div class="ps-row"><span class="k">حق اولاد</span><span class="v"><%= money.call(child) %></span></div>
        </div>
      </div>

      <%# --- قانونی (تجمیعی‌ها نزدیک هم) --- %>
      <div class="col-12 col-lg-4">
        <div class="ps-section">
          <div class="hd">محاسبات قانونی</div>

          <div class="ps-row"><span class="k">حقوق قانونی</span><span class="v"><%= money.call(legal_salary) %></span></div>
          <div class="ps-row"><span class="k">بیمه (۷٪)</span><span class="v"><%= money.call(insurance) %></span></div>

          <div class="ps-row">
            <span class="k"><strong>پرداختی اول</strong></span>
            <span class="v"><strong><%= money.call(payment_1) %></strong></span>
          </div>

          <div class="ps-mini mt-2">
            فرمول: (حقوق پایه + مسکن + خواربار + تأهل + اولاد + سنوات) − بیمه
          </div>
        </div>
      </div>

      <%# --- کارکرد (ساعت‌ها کنار هم + نرخ) --- %>
      <div class="col-12 col-lg-4">
        <div class="ps-section">
          <div class="hd">کارکرد و حقوق مصوب</div>

          <div class="ps-row"><span class="k">حقوق مصوب (<%= month_days %> روز)</span><span class="v"><%= money.call(total_salary_adj) %></span></div>
          <div class="ps-row"><span class="k">مجموع ساعات کاری</span><span class="v"><%= total_work_h %> ساعت</span></div>
          <div class="ps-row"><span class="k">نرخ ساعتی</span><span class="v"><%= number_with_delimiter(hourly_rate.round(2)) %></span></div>

          <div class="ps-row"><span class="k">ساعت اضافه‌کاری</span><span class="v"><%= overtime_h %> ساعت</span></div>
          <div class="ps-row"><span class="k">ساعت کسری</span><span class="v"><%= deficit_h %> ساعت</span></div>
        </div>
      </div>

      <%# --- کسورات / تعدیلات (مرتبط‌ها کنار هم) --- %>
      <div class="col-12 col-lg-7">
        <div class="ps-section">
          <div class="hd">کسورات و تعدیلات</div>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <div class="ps-row"><span class="k">قسط وام</span><span class="v"><%= money.call(loan) %></span></div>
              <div class="ps-row"><span class="k">ذخیره ۳٪</span><span class="v"><%= money.call(fund3) %></span></div>
              <div class="ps-row"><span class="k">ذخیره ۶٪</span><span class="v"><%= money.call(fund6) %></span></div>
            </div>

            <div class="col-12 col-md-6">
              <div class="ps-row"><span class="k">کسر کسری (ساعت × نرخ)</span><span class="v"><%= money.call(deficit_deduction.round) %></span></div>
              <div class="ps-row"><span class="k">افزودن اضافه‌کاری (×۱.۴)</span><span class="v"><%= money.call(overtime_pay.round) %></span></div>
              <div class="ps-mini mt-2">این بخش مستقیماً روی پرداختی دوم اثر می‌گذارد.</div>
            </div>
          </div>
        </div>
      </div>

      <%# --- خلاصه پرداختی‌ها (کنار هم، جمع‌بندی) --- %>
      <div class="col-12 col-lg-5">
        <div class="ps-section" style="background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,0));">
          <div class="hd">خلاصه پرداختی‌ها</div>

          <div class="ps-row">
            <span class="k">پرداختی اول (قانونی)</span>
            <span class="v"><%= money.call(payment_1) %></span>
          </div>

          <div class="ps-row">
            <span class="k">پرداختی دوم</span>
            <span class="v"><%= money.call(payment_2) %></span>
          </div>

          <div class="ps-mini mt-2">
            پرداختی اول مربوط به محاسبات قانونی است و پرداختی دوم بر اساس حقوق مصوب و ساعات اضافه‌کاری/کسری محاسبه می‌شود.
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="ps-footer">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="ps-mini">
        تولید شده از آرشیو <strong>#<%= archive.id %></strong> • ماه <strong><%= shamsi_month.name %></strong>
      </div>

      <div class="d-flex align-items-center gap-2">
        <span class="ps-pill">پرداختی اول: <strong><%= money.call(payment_1) %></strong></span>
        <span class="ps-pill">پرداختی دوم: <strong><%= money.call(payment_2) %></strong></span>
      </div>
    </div>
  </div>
</div>
