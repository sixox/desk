<%# app/views/salary_archives/_payslip_card.html.erb %>
<%
  # ---- helpers کوچک داخل partial ----
  money = ->(n) { number_with_delimiter(n.to_i) }
  hours = ->(mins) { ((mins.to_i) / 60.0).round(2) }

  month_days = (shamsi_month.end_at.to_date - shamsi_month.start_at.to_date).to_i + 1
  adjust_30_to_month = ->(monthly_amount) { ((monthly_amount.to_f / 30.0) * month_days).round }

  # ---- داده‌ها از archive ----
  base_salary   = archive.seniority_base.to_i
  paye_sanavat  = archive.monthly_seniority_base.to_i

  marriage      = archive.marriage_allowance.to_i
  child         = archive.child_allowance.to_i
  housing       = archive.housing_allowance.to_i
  food          = archive.food_allowance.to_i

  legal_salary  = base_salary + marriage + housing + food + paye_sanavat
  insurance     = archive.insurance.to_i
  payment_1     = legal_salary - insurance

  total_salary_adj = adjust_30_to_month.call(archive.total_salary.to_i)

  total_work_h = hours.call(archive.total_work_minutes)

  overtime_mins = archive.manual_overtime_minutes.to_i != 0 ? archive.manual_overtime_minutes.to_i : archive.overtime_minutes.to_i
  deficit_mins  = archive.manual_deficit_minutes.to_i  != 0 ? archive.manual_deficit_minutes.to_i  : archive.deficit_minutes.to_i

  overtime_h = hours.call(overtime_mins)
  deficit_h  = hours.call(deficit_mins)

  hourly_rate = archive.hourly_rate.present? ? archive.hourly_rate.to_f : 0.0

  loan   = archive.loan_installment.to_i
  fund3  = archive.fund_three_percent.to_i
  fund6  = archive.fund_six_percent.to_i

  overtime_pay      = (overtime_h * hourly_rate * 1.4)
  deficit_deduction = (deficit_h  * hourly_rate)

  payment_2 = (total_salary_adj - fund6 - fund3 - loan - deficit_deduction + overtime_pay).round
%>

<div class="card border-0 shadow-sm" id="payslip_card_<%= archive.id %>" style="border-radius: 16px;">
  <div class="card-body p-3 p-md-4">

    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
      <div>
        <div class="fw-bold" style="font-size: 1.05rem;">
          فیش حقوقی — <%= user&.name.presence || "کاربر ##{archive.user_id}" %>
        </div>
        <div class="text-muted small">
          ماه: <%= shamsi_month.name %> • تعداد روز: <%= month_days %>
        </div>
      </div>

      <div class="text-end">
        <div class="text-muted small">پرداختی اول (قانونی)</div>
        <div class="fw-bold" style="font-size: 1.15rem;">
          <%= money.call(payment_1) %>
        </div>
      </div>
    </div>

    <div class="row g-3">

      <%# -------- بخش پایه‌ها -------- %>
      <div class="col-12 col-lg-6">
        <div class="p-3 bg-light border" style="border-radius: 14px;">
          <div class="fw-semibold mb-2">حقوق پایه و مزایا</div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">حقوق پایه</span>
            <span class="fw-semibold"><%= money.call(base_salary) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">پایه سنوات</span>
            <span class="fw-semibold"><%= money.call(paye_sanavat) %></span>
          </div>

          <hr class="my-2">

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">حق تأهل</span>
            <span class="fw-semibold"><%= money.call(marriage) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">حق اولاد</span>
            <span class="fw-semibold"><%= money.call(child) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">حق مسکن</span>
            <span class="fw-semibold"><%= money.call(housing) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">خواربار</span>
            <span class="fw-semibold"><%= money.call(food) %></span>
          </div>
        </div>
      </div>

      <%# -------- بخش قانونی -------- %>
      <div class="col-12 col-lg-6">
        <div class="p-3 border" style="border-radius: 14px;">
          <div class="fw-semibold mb-2">محاسبات قانونی</div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">حقوق قانونی</span>
            <span class="fw-semibold"><%= money.call(legal_salary) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">بیمه (۷٪)</span>
            <span class="fw-semibold"><%= money.call(insurance) %></span>
          </div>

          <hr class="my-2">

          <div class="d-flex justify-content-between py-2" style="border-radius: 10px;">
            <span class="fw-semibold">پرداختی اول</span>
            <span class="fw-bold"><%= money.call(payment_1) %></span>
          </div>

          <div class="text-muted small">
            فرمول: (حقوق قانونی − بیمه)
          </div>
        </div>
      </div>

      <%# -------- حقوق مصوب/کارکرد -------- %>
      <div class="col-12">
        <div class="p-3 bg-light border" style="border-radius: 14px;">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            <div class="fw-semibold">کارکرد و حقوق مصوب ماه</div>
            <div class="small text-muted">
              حقوق مصوب برای <%= month_days %> روز
            </div>
          </div>

          <div class="row g-2 small">
            <div class="col-12 col-md-4">
              <div class="d-flex justify-content-between py-1">
                <span class="text-muted">حقوق مصوب</span>
                <span class="fw-semibold"><%= money.call(total_salary_adj) %></span>
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="d-flex justify-content-between py-1">
                <span class="text-muted">مجموع ساعات کاری</span>
                <span class="fw-semibold"><%= total_work_h %> ساعت</span>
              </div>
            </div>

            <div class="col-12 col-md-4">
              <div class="d-flex justify-content-between py-1">
                <span class="text-muted">نرخ ساعتی</span>
                <span class="fw-semibold"><%= number_with_delimiter(hourly_rate.round(2)) %></span>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="d-flex justify-content-between py-1">
                <span class="text-muted">ساعت اضافه‌کاری</span>
                <span class="fw-semibold"><%= overtime_h %> ساعت</span>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="d-flex justify-content-between py-1">
                <span class="text-muted">ساعت کسری</span>
                <span class="fw-semibold"><%= deficit_h %> ساعت</span>
              </div>
            </div>
          </div>

        </div>
      </div>

      <%# -------- کسورات/ذخایر -------- %>
      <div class="col-12 col-lg-6">
        <div class="p-3 border" style="border-radius: 14px;">
          <div class="fw-semibold mb-2">کسورات</div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">قسط وام</span>
            <span class="fw-semibold"><%= money.call(loan) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">ذخیره ۳٪</span>
            <span class="fw-semibold"><%= money.call(fund3) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">ذخیره ۶٪</span>
            <span class="fw-semibold"><%= money.call(fund6) %></span>
          </div>

          <hr class="my-2">

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">کسر بابت کسری (ساعت × نرخ)</span>
            <span class="fw-semibold"><%= money.call(deficit_deduction.round) %></span>
          </div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">افزودن بابت اضافه‌کاری (ساعت × نرخ × ۱.۴)</span>
            <span class="fw-semibold"><%= money.call(overtime_pay.round) %></span>
          </div>
        </div>
      </div>

      <%# -------- جمع‌بندی پرداختی دوم -------- %>
      <div class="col-12 col-lg-6">
        <div class="p-3 bg-light border" style="border-radius: 14px;">
          <div class="fw-semibold mb-2">جمع‌بندی پرداختی دوم</div>

          <div class="d-flex justify-content-between small py-1">
            <span class="text-muted">مبنای پرداختی (حقوق مصوب)</span>
            <span class="fw-semibold"><%= money.call(total_salary_adj) %></span>
          </div>

          <div class="text-muted small mt-2">
            فرمول: (حقوق مصوب − ذخیره۶٪ − ذخیره۳٪ − قسط وام − (کسری×نرخ) + (اضافه‌کاری×نرخ×۱.۴))
          </div>

          <hr class="my-3">

          <div class="d-flex align-items-center justify-content-between">
            <span class="fw-bold">پرداختی دوم</span>
            <span class="fw-bold" style="font-size: 1.15rem;"><%= money.call(payment_2) %></span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="card-footer bg-white border-0 px-3 px-md-4 pb-3 pt-0">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-2"
         style="border-top: 1px dashed #ddd; padding-top: 12px;">
      <div class="small text-muted">
        فیش تولید شده از آرشیو: <span class="fw-semibold">#<%= archive.id %></span>
      </div>

      <div class="d-flex align-items-center gap-3">
        <div class="text-end">
          <div class="text-muted small">پرداختی اول</div>
          <div class="fw-bold"><%= money.call(payment_1) %></div>
        </div>

        <div class="text-end">
          <div class="text-muted small">پرداختی دوم</div>
          <div class="fw-bold"><%= money.call(payment_2) %></div>
        </div>
      </div>
    </div>
  </div>
</div>
