<!-- app/views/projects/turnovers.html.erb -->
<div class="col-lg-11 mx-auto mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Projects â€” DSO (Turnovers)</h4>
    <%= link_to "Back to Projects", projects_path, class: "btn btn-sm btn-outline-secondary" %>
  </div>

  <% if @rows.blank? %>
    <div class="alert alert-warning">No eligible projects yet (some payments are still pending or no booking).</div>
  <% end %>

<div class="row g-3">
  <% @rows.each do |row| %>
    <% pid    = row.project.id %>
    <% collapse_id = "turnover_row_#{pid}" %>

    <div class="col-12">
      <div class="card border-0 shadow">
        <div class="card-body p-xl-4" style="background:#ced1e1;">
          <div class="card card-custom mt-2 mb-0">
            <div class="card-body py-3">
              <div class="row d-flex justify-content-between align-items-center">
                <div class="col-auto">
                  <h6 class="fw-bold mb-0">
                    Project:
                    <%= link_to row.project.number, project_path(row.project), class: "fw-bold text-info text-decoration-none" %>
                  </h6>
                </div>
                <div class="col-auto d-none d-sm-block">
                  <h6 class="card-subtitle text-secondary mb-0">
                    <span class="text-danger"><i class="bi bi-activity"></i></span>
                    <span class="timeline-small">Days Sales Outstanding</span>
                    <span class="text-danger"><i class="bi bi-activity"></i></span>
                  </h6>
                </div>
                <div class="col-auto">
                  <h6 class="text-success mb-0">
                    <%= number_with_precision(row.dso_days, precision: 1) %>
                    <small class="text-secondary">Days</small>
                  </h6>
                </div>

                <!-- Toggle details -->
                <div class="col-auto">
                  <button class="btn btn-sm btn-outline-secondary"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="##{collapse_id}"
                          aria-expanded="false"
                          aria-controls="<%= collapse_id %>">
                    <i class="bi bi-chevron-down"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Collapsible details -->
          <div id="<%= collapse_id %>" class="collapse">
            <div class="container pt-3">
              <div class="row">
                <!-- Payments -->
                <div class="col-lg-6 col-12 mb-4">
                  <div class="card card-custom mt-1 h-100">
                    <div class="card-body d-flex flex-column">
                      <h3>Payments</h3>
                      <table class="table table-striped flex-grow-1 mb-0">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Amount</th>
                            <th>Currency</th>
                            <th>Status</th>
                            <th>Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if row.payments_table.present? %>
                            <% row.payments_table.each do |payment| %>
                              <tr>
                                <td><%= link_to payment.id, payment_order_path(payment), class: "link-nodecor-po" %></td>
                                <td class="fw-bold"><%= number_with_precision(payment.amount.to_i, precision: 0, delimiter: ",") %></td>
                                <td><small><%= payment.currency %></small></td>
                                <td><%= payment.status %></td>
                                <td><small><%= payment.ceo_confirmed_at.present? ? payment.ceo_confirmed_at.strftime("%Y-%m-%d") : "-" %></small></td>
                              </tr>
                            <% end %>
                          <% else %>
                            <tr><td colspan="5" class="text-muted">No payments</td></tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Swifts -->
                <div class="col-lg-6 col-12 mb-4">
                  <div class="card card-custom mt-1 h-100">
                    <div class="card-body d-flex flex-column">
                      <h3>Swifts</h3>
                      <table class="table table-striped flex-grow-1 mb-0">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Amount</th>
                            <th>Currency</th>
                            <th>Status</th>
                            <th>Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if row.swifts_table.present? %>
                            <% row.swifts_table.each do |swift| %>
                              <tr>
                                <td><%= swift.id %></td>
                                <td class="fw-bold"><%= number_with_precision(swift.amount.to_i, precision: 0, delimiter: ",") %></td>
                                <td><small><%= swift.currency %></small></td>
                                <td><%= swift.confirmed ? "Confirmed" : "-" %></td>
                                <td><small><%= swift.created_at.strftime("%Y-%m-%d") %></small></td>
                              </tr>
                            <% end %>
                          <% else %>
                            <tr><td colspan="5" class="text-muted">No swifts</td></tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div> <!-- /row -->
            </div> <!-- /container -->
          </div> <!-- /collapse -->

        </div> <!-- /card-body (outer) -->
      </div> <!-- /card -->
    </div> <!-- /col -->
  <% end %>
</div>

  <div class="row mt-3">
    <div class="col-sm">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <%= paginate @projects_page %>
        </ul>
      </nav>
    </div>
  </div>

</div>
