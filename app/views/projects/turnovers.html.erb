<div class="col-lg-10 mx-auto mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Projects â€” DSO (Turnovers)</h4>
    <%= link_to "Back to Projects", projects_path, class: "btn btn-sm btn-outline-secondary" %>
  </div>

  <!-- Customer filter -->
  <div class="card mb-3">
    <div class="card-body">
      <%= form_with url: turnovers_projects_path, method: :get, local: true do %>
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <label class="form-label mb-1">Customer</label>
            <select name="customer_id" class="form-select form-select-sm">
              <option value="">All</option>
              <% @customers.each do |c| %>
                <option value="<%= c.id %>" <%= 'selected' if params[:customer_id].to_s == c.id.to_s %>>
                  <%= c.try(:nickname).presence || c.try(:name).presence || "Customer ##{c.id}" %>
                </option>
              <% end %>
            </select>
          </div>
          <div class="col-md-6 text-end">
            <button class="btn btn-sm btn-primary">Apply</button>
            <%= link_to "Reset", turnovers_projects_path, class: "btn btn-sm btn-outline-secondary" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <% if @rows.blank? %>
    <div class="alert alert-warning">No eligible projects yet (some payments are still pending or no booking).</div>
  <% end %>

  <div class="accordion" id="accordionTurnovers">
    <% @rows.each do |row| %>
      <% pid = row.project.id %>
      <% heading_id  = "heading_#{pid}" %>
      <% collapse_id = "collapse_#{pid}" %>

      <div class="accordion-item border-0 shadow mb-3">
        <h2 class="accordion-header" id="<%= heading_id %>">
          <button class="accordion-button collapsed d-flex justify-content-between w-100"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#<%= collapse_id %>"
                  aria-expanded="false"
                  aria-controls="<%= collapse_id %>">
            <!-- Left: Project link -->
            <span class="fw-bold">
              Project:
              <%= link_to row.project.number, project_path(row.project),
                          class: "fw-bold text-info text-decoration-none" %>
            </span>

            <!-- Middle: DSO label (hidden on xs) -->
            <span class="card-subtitle text-secondary d-none d-sm-inline">
              <span class="text-danger"><i class="bi bi-activity"></i></span>
              <span class="timeline-small">Days Sales Outstanding</span>
              <span class="text-danger"><i class="bi bi-activity"></i></span>
            </span>

            <!-- Right: DSO value -->
            <span class="text-success">
              <%= number_with_precision(row.dso_days, precision: 1) %>
              <small class="text-secondary">Days</small>
            </span>
          </button>
        </h2>

        <div id="<%= collapse_id %>" class="accordion-collapse collapse"
             aria-labelledby="<%= heading_id %>"
             data-bs-parent="#accordionTurnovers">
          <div class="accordion-body" style="background:#ced1e1;">
            <div class="container pt-2">
              <div class="row">
                <!-- Payments -->
                <div class="col-lg-6 col-12 mb-4">
                  <div class="card card-custom h-100">
                    <div class="card-body d-flex flex-column">
                      <h3>Payments</h3>
                      <table class="table table-striped flex-grow-1 mb-0">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Amount</th>
                            <th>Currency</th>
                            <th>Status</th>
                            <th>Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if row.payments_table.present? %>
                            <% row.payments_table.each do |payment| %>
                              <tr>
                                <td><%= link_to payment.id, payment_order_path(payment), class: "link-nodecor-po" %></td>
                                <td class="fw-bold"><%= number_with_precision(payment.amount.to_i, precision: 0, delimiter: ",") %></td>
                                <td><small><%= payment.currency %></small></td>
                                <td><%= payment.status %></td>
                                <td><small><%= payment.ceo_confirmed_at.present? ? payment.ceo_confirmed_at.strftime("%Y-%m-%d") : "-" %></small></td>
                              </tr>
                            <% end %>
                          <% else %>
                            <tr><td colspan="5" class="text-muted">No payments</td></tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Swifts -->
                <div class="col-lg-6 col-12 mb-4">
                  <div class="card card-custom h-100">
                    <div class="card-body d-flex flex-column">
                      <h3>Swifts</h3>
                      <table class="table table-striped flex-grow-1 mb-0">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Amount</th>
                            <th>Currency</th>
                            <th>Status</th>
                            <th>Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if row.swifts_table.present? %>
                            <% row.swifts_table.each do |swift| %>
                              <tr>
                                <td><%= swift.id %></td>
                                <td class="fw-bold"><%= number_with_precision(swift.amount.to_i, precision: 0, delimiter: ",") %></td>
                                <td><small><%= swift.currency %></small></td>
                                <td><%= swift.confirmed ? "Confirmed" : "-" %></td>
                                <td><small><%= swift.created_at.strftime("%Y-%m-%d") %></small></td>
                              </tr>
                            <% end %>
                          <% else %>
                            <tr><td colspan="5" class="text-muted">No swifts</td></tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div> <!-- /row -->
            </div> <!-- /container -->
          </div> <!-- /accordion-body -->
        </div> <!-- /accordion-collapse -->
      </div> <!-- /accordion-item -->
    <% end %>
  </div>

  <div class="row mt-3">
    <div class="col-sm">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <%= paginate @projects_page %>
        </ul>
      </nav>
    </div>
  </div>
</div>
