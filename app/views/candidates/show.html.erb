<!-- app/views/candidates/show.html.erb -->
<div class="col-lg-10 mx-auto mt-4" dir="rtl">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">پرونده متقاضی — <%= @candidate.name %></h3>
    <span class="text-muted"><%= @candidate.phone %> · <%= @candidate.role.to_s.capitalize %></span>
  </div>

  <% can_hr     = current_user&.role == "hr"  || current_user&.role == "admin" %>
  <% can_ceo    = current_user&.role == "ceo" || (current_user&.is_manager && current_user&.role == "procurement") || current_user&.role == "admin" %>
  <% can_acct   = (current_user&.role == "accounting" && @candidate.role.to_s.downcase == "accounting") || current_user&.role == "admin" || current_user&.role == "hr" %>
  <% can_other  = ((current_user&.role.to_s.downcase == @candidate.role.to_s.downcase) && current_user&.is_manager) || current_user&.role == "admin" || current_user&.role == "hr" %>

  <% @dept_key, @dept_label =
      if @candidate.role.to_s.downcase == "accounting"
        ["Accounting", "Accounting"]
      else
        ["Other", (@candidate.role.presence || "Other").to_s.capitalize]
      end %>

  <% def visible_questions(e)
       e.questions.order(:position).select { |q| q.fixed? || (q.text.present? && (q.weight.present? || q.score.present?)) }
     end %>

  <% def score_pair(e); [e.taken_score, e.max_score]; end %>

  <% def grade_pills(selected)
       CandidateEvaluation::GRADES.map do |g|
         cls = (g == selected) ? "btn btn-sm btn-primary" : "btn btn-sm btn-outline-secondary"
         "<span class='#{cls} mx-1 my-1 disabled' tabindex='-1'>#{ERB::Util.html_escape(g)}</span>"
       end.join
     end %>

  <!-- 1) Candidate self form (FULL read-only; no button) -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>فرم اطلاعات متقاضی (تکمیل‌شده توسط متقاضی)</strong>
      <div class="small">
        <% if @profile.present? %>
          <span class="text-success"><i class="bi bi-check2-circle"></i> موجود</span>
        <% else %>
          <span class="text-muted">فرمی ثبت نشده</span>
        <% end %>
      </div>
    </div>
    <div class="card-body">
      <% if @profile.present? %>
        <%= render "candidate_portal/profile/read_only", data: (@profile.data || {}) %>
      <% else %>
        <div class="alert alert-warning mb-0">فرم متقاضی هنوز تکمیل نشده است.</div>
      <% end %>
    </div>
  </div>

  <!-- 2) HR evaluation -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>فرم ارزیابی — منابع انسانی (HR)</strong>
      <div>
        <% if @hr_eval.present? %>
          <% t, m = score_pair(@hr_eval) %>
          <span class="badge bg-info"><i class="bi bi-calculator"></i> <%= t %> / <%= m %></span>
        <% else %>
          <span class="text-muted">فرمی ثبت نشده</span>
        <% end %>
      </div>
    </div>
    <div class="card-body">
      <% if @hr_eval.present? %>
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-end">سؤال</th>
                <th class="text-center">وزن</th>
                <th class="text-center">امتیاز</th>
                <th class="text-center">وزنی</th>
              </tr>
            </thead>
            <tbody>
              <% visible_questions(@hr_eval).each do |q| %>
                <tr>
                  <td class="text-end"><%= q.text %> <%= raw(q.fixed? ? '<span class="badge bg-secondary ms-1">ثابت</span>' : '') %></td>
                  <td class="text-center"><%= q.weight %></td>
                  <td class="text-center"><%= q.score || "—" %></td>
                  <td class="text-center"><%= q.score.present? ? q.score * q.weight : "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Comment + Grade 'select' (read-only pills) -->
        <div class="row g-3 align-items-start mt-2">
          <div class="col-md-8">
            <h6 class="mb-1">نظر ارزیاب</h6>
            <div class="border rounded p-2 bg-light"><%= @hr_eval.comment.presence || "—" %></div>
          </div>
          <div class="col-md-4">
            <h6 class="mb-1">ارزیابی کلی</h6>
            <div class="d-flex flex-wrap" aria-label="overall-grade">
              <%= raw grade_pills(@hr_eval.overall_grade) %>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <% if can_hr %>
            <%= link_to edit_candidate_candidate_evaluation_path(@candidate, department: "HR"),
                        data: { controller: "bs-modal-form" },
                        class: "btn btn-sm btn-outline-primary" do %>
              <i class="bi bi-pencil-square"></i> ویرایش
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">فرم HR موجود نیست.</div>
        <% if can_hr %>
          <%= link_to new_candidate_candidate_evaluation_path(@candidate, department: "HR"),
                      data: { controller: "bs-modal-form" },
                      class: "btn btn-sm btn-success" do %>
            <i class="bi bi-plus-circle"></i> ایجاد فرم HR
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- 3) Department evaluation (Accounting or Other/Role) -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>فرم ارزیابی — <%= @dept_label %></strong>
      <div>
        <% if @dept_eval.present? %>
          <% t, m = score_pair(@dept_eval) %>
          <span class="badge bg-info"><i class="bi bi-calculator"></i> <%= t %> / <%= m %></span>
        <% else %>
          <span class="text-muted">فرمی ثبت نشده</span>
        <% end %>
      </div>
    </div>
    <div class="card-body">
      <% if @dept_eval.present? %>
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-end">سؤال</th>
                <th class="text-center">وزن</th>
                <th class="text-center">امتیاز</th>
                <th class="text-center">وزنی</th>
              </tr>
            </thead>
            <tbody>
              <% visible_questions(@dept_eval).each do |q| %>
                <tr>
                  <td class="text-end"><%= q.text %> <%= raw(q.fixed? ? '<span class="badge bg-secondary ms-1">ثابت</span>' : '') %></td>
                  <td class="text-center"><%= q.weight %></td>
                  <td class="text-center"><%= q.score || "—" %></td>
                  <td class="text-center"><%= q.score.present? ? q.score * q.weight : "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Comment + Grade -->
        <div class="row g-3 align-items-start mt-2">
          <div class="col-md-8">
            <h6 class="mb-1">نظر ارزیاب</h6>
            <div class="border rounded p-2 bg-light"><%= @dept_eval.comment.presence || "—" %></div>
          </div>
          <div class="col-md-4">
            <h6 class="mb-1">ارزیابی کلی</h6>
            <div class="d-flex flex-wrap"><%= raw grade_pills(@dept_eval.overall_grade) %></div>
          </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <% can_dept = (@dept_key == "Accounting") ? can_acct : can_other %>
          <% if can_dept %>
            <%= link_to edit_candidate_candidate_evaluation_path(@candidate, department: @dept_key),
                        data: { controller: "bs-modal-form" },
                        class: "btn btn-sm btn-outline-primary" do %>
              <i class="bi bi-pencil-square"></i> ویرایش
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">فرم <%= @dept_label %> موجود نیست.</div>
        <% can_dept = (@dept_key == "Accounting") ? can_acct : can_other %>
        <% if can_dept %>
          <%= link_to new_candidate_candidate_evaluation_path(@candidate, department: @dept_key),
                      data: { controller: "bs-modal-form" },
                      class: "btn btn-sm btn-success" do %>
            <i class="bi bi-plus-circle"></i> ایجاد فرم <%= @dept_label %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- 4) CEO evaluation -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>فرم ارزیابی — CEO</strong>
      <div>
        <% if @ceo_eval.present? %>
          <% t, m = score_pair(@ceo_eval) %>
          <span class="badge bg-info"><i class="bi bi-calculator"></i> <%= t %> / <%= m %></span>
        <% else %>
          <span class="text-muted">فرمی ثبت نشده</span>
        <% end %>
      </div>
    </div>
    <div class="card-body">
      <% if @ceo_eval.present? %>
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-end">سؤال</th>
                <th class="text-center">وزن</th>
                <th class="text-center">امتیاز</th>
                <th class="text-center">وزنی</th>
              </tr>
            </thead>
            <tbody>
              <% visible_questions(@ceo_eval).each do |q| %>
                <tr>
                  <td class="text-end"><%= q.text %> <%= raw(q.fixed? ? '<span class="badge bg-secondary ms-1">ثابت</span>' : '') %></td>
                  <td class="text-center"><%= q.weight %></td>
                  <td class="text-center"><%= q.score || "—" %></td>
                  <td class="text-center"><%= q.score.present? ? q.score * q.weight : "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Comment + Grade -->
        <div class="row g-3 align-items-start mt-2">
          <div class="col-md-8">
            <h6 class="mb-1">نظر ارزیاب</h6>
            <div class="border rounded p-2 bg-light"><%= @ceo_eval.comment.presence || "—" %></div>
          </div>
          <div class="col-md-4">
            <h6 class="mb-1">ارزیابی کلی</h6>
            <div class="d-flex flex-wrap"><%= raw grade_pills(@ceo_eval.overall_grade) %></div>
          </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <% if can_ceo %>
            <%= link_to edit_candidate_candidate_evaluation_path(@candidate, department: "CEO"),
                        data: { controller: "bs-modal-form" },
                        class: "btn btn-sm btn-outline-primary" do %>
              <i class="bi bi-pencil-square"></i> ویرایش
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">فرم CEO موجود نیست.</div>
        <% if can_ceo %>
          <%= link_to new_candidate_candidate_evaluation_path(@candidate, department: "CEO"),
                      data: { controller: "bs-modal-form" },
                      class: "btn btn-sm btn-success" do %>
            <i class="bi bi-plus-circle"></i> ایجاد فرم CEO
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
